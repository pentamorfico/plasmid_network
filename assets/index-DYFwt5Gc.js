const C=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],b=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],_e=["REQUIRED","OPTIONAL","REPEATED"],ae=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],de=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],W=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],Z={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)}};function $(e,t,n,f){if(t&&n.endsWith("_DICTIONARY")){let i=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(i=new t.constructor(e.length));for(let r=0;r<e.length;r++)i[r]=t[e[r]];return i}else return Q(e,f)}function Q(e,t){const{element:n,parsers:f,utf8:i=!0}=t,{type:r,converted_type:s,logical_type:o}=n;if(s==="DECIMAL"){const l=10**-(n.scale||0),c=new Array(e.length);for(let _=0;_<c.length;_++)e[0]instanceof Uint8Array?c[_]=K(e[_])*l:c[_]=Number(e[_])*l;return c}if(!s&&r==="INT96"){const u=new Array(e.length);for(let l=0;l<u.length;l++)u[l]=f.timestampFromNanoseconds(he(e[l]));return u}if(s==="DATE"){const u=new Array(e.length);for(let l=0;l<u.length;l++)u[l]=f.dateFromDays(e[l]);return u}if(s==="TIMESTAMP_MILLIS"){const u=new Array(e.length);for(let l=0;l<u.length;l++)u[l]=f.timestampFromMilliseconds(e[l]);return u}if(s==="TIMESTAMP_MICROS"){const u=new Array(e.length);for(let l=0;l<u.length;l++)u[l]=f.timestampFromMicroseconds(e[l]);return u}if(s==="JSON"){const u=new TextDecoder;return e.map(l=>JSON.parse(u.decode(l)))}if(s==="BSON")throw new Error("parquet bson not supported");if(s==="INTERVAL")throw new Error("parquet interval not supported");if(s==="UTF8"||(o==null?void 0:o.type)==="STRING"||i&&r==="BYTE_ARRAY"){const u=new TextDecoder,l=new Array(e.length);for(let c=0;c<l.length;c++)l[c]=e[c]&&u.decode(e[c]);return l}if(s==="UINT_64"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===64&&!o.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const u=new BigUint64Array(e.length);for(let l=0;l<u.length;l++)u[l]=BigInt(e[l]);return u}if(s==="UINT_32"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===32&&!o.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const u=new Uint32Array(e.length);for(let l=0;l<u.length;l++)u[l]=e[l];return u}if((o==null?void 0:o.type)==="FLOAT16")return Array.from(e).map(X);if((o==null?void 0:o.type)==="TIMESTAMP"){const{unit:u}=o;let l=f.timestampFromMilliseconds;u==="MICROS"&&(l=f.timestampFromMicroseconds),u==="NANOS"&&(l=f.timestampFromNanoseconds);const c=new Array(e.length);for(let _=0;_<c.length;_++)c[_]=l(e[_]);return c}return e}function K(e){let t=0;for(const f of e)t=t*256+f;const n=e.length*8;return t>=2**(n-1)&&(t-=2**n),t}function he(e){const t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function X(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,f=t>>10&31,i=t&1023;return f===0?n*2**-14*(i/1024):f===31?i?NaN:n*(1/0):n*2**(f-15)*(1+i/1024)}function H(e,t,n){const f=e[t],i=[];let r=1;if(f.num_children)for(;i.length<f.num_children;){const s=e[t+r],o=H(e,t+r,[...n,s.name]);r+=o.count,i.push(o)}return{count:r,element:f,children:i,path:n}}function J(e,t){let n=H(e,0,[]);const f=[n];for(const i of t){const r=n.children.find(s=>s.element.name===i);if(!r)throw new Error(`parquet schema element not found: ${t}`);f.push(r),n=r}return f}function ee(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function M(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function we(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Ae(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];if(t.children.length!==2||t.element.repetition_type!=="REPEATED")return!1;const n=t.children.find(i=>i.element.name==="key");if((n==null?void 0:n.element.repetition_type)==="REPEATED")return!1;const f=t.children.find(i=>i.element.name==="value");return(f==null?void 0:f.element.repetition_type)!=="REPEATED"}function me(e){if(e.length!==2)return!1;const[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}const p={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,STRUCT:12};function te(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[f,i,r]=ie(e,t);if(t=r,f===p.STOP)break;n[`field_${i}`]=O(e,f)}return n}function O(e,t){switch(t){case p.TRUE:return!0;case p.FALSE:return!1;case p.BYTE:return e.view.getInt8(e.offset++);case p.I16:case p.I32:return Ee(e);case p.I64:return B(e);case p.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case p.BINARY:{const n=v(e),f=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,f}case p.LIST:{const[n,f]=pe(e),i=n===p.TRUE||n===p.FALSE,r=new Array(f);for(let s=0;s<f;s++)r[s]=i?O(e,p.BYTE)===1:O(e,n);return r}case p.STRUCT:{const n={};let f=0;for(;;){let i,r;if([i,r,f]=ie(e,f),i===p.STOP)break;n[`field_${r}`]=O(e,i)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function v(e){let t=0,n=0;for(;;){const f=e.view.getUint8(e.offset++);if(t|=(f&127)<<n,!(f&128))return t;n+=7}}function ge(e){let t=0n,n=0n;for(;;){const f=e.view.getUint8(e.offset++);if(t|=BigInt(f&127)<<n,!(f&128))return t;n+=7n}}function Ee(e){const t=v(e);return t>>>1^-(t&1)}function B(e){const t=ge(e);return t>>1n^-(t&1n)}function ne(e){return e&15}function ie(e,t){const n=e.view.getUint8(e.offset++);if((n&15)===p.STOP)return[0,0,t];const f=n>>4;let i;if(f)i=t+f;else throw new Error("non-delta field id not supported");return[ne(n),i,i]}function pe(e){const t=e.view.getUint8(e.offset++),n=t>>4,f=ne(t);if(n===15){const i=v(e);return[f,i]}return[f,n]}const Ie=1<<19;async function ye(e,{parsers:t,initialFetchSize:n=Ie}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const f=Math.max(0,e.byteLength-n),i=await e.slice(f,e.byteLength),r=new DataView(i);if(r.getUint32(i.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const s=r.getUint32(i.byteLength-8,!0);if(s>e.byteLength-8)throw new Error(`parquet metadata length ${s} exceeds available buffer ${e.byteLength-8}`);if(s+8>n){const o=e.byteLength-s-8,u=await e.slice(o,f),l=new ArrayBuffer(s+8),c=new Uint8Array(l);return c.set(new Uint8Array(u)),c.set(new Uint8Array(i),f-o),k(l,{parsers:t})}else return k(i,{parsers:t})}function k(e,{parsers:t}={}){var A;if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const n=new DataView(e);if(t={...Z,...t},n.byteLength<8)throw new Error("parquet file is too short");if(n.getUint32(n.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const f=n.byteLength-8,i=n.getUint32(f,!0);if(i>n.byteLength-8)throw new Error(`parquet metadata length ${i} exceeds available buffer ${n.byteLength-8}`);const r=f-i,o=te({view:n,offset:r}),u=new TextDecoder;function l(h){return h&&u.decode(h)}const c=o.field_1,_=o.field_2.map(h=>({type:C[h.field_1],type_length:h.field_2,repetition_type:_e[h.field_3],name:l(h.field_4),num_children:h.field_5,converted_type:ae[h.field_6],scale:h.field_7,precision:h.field_8,field_id:h.field_9,logical_type:ve(h.field_10)})),a=_.filter(h=>h.type),w=o.field_3,d=o.field_4.map(h=>{var I;return{columns:h.field_1.map((m,ce)=>{var q,Y;return{file_path:l(m.field_1),file_offset:m.field_2,meta_data:m.field_3&&{type:C[m.field_3.field_1],encodings:(q=m.field_3.field_2)==null?void 0:q.map(L=>b[L]),path_in_schema:m.field_3.field_3.map(l),codec:de[m.field_3.field_4],num_values:m.field_3.field_5,total_uncompressed_size:m.field_3.field_6,total_compressed_size:m.field_3.field_7,key_value_metadata:m.field_3.field_8,data_page_offset:m.field_3.field_9,index_page_offset:m.field_3.field_10,dictionary_page_offset:m.field_3.field_11,statistics:Le(m.field_3.field_12,a[ce],t),encoding_stats:(Y=m.field_3.field_13)==null?void 0:Y.map(L=>({page_type:W[L.field_1],encoding:b[L.field_2],count:L.field_3})),bloom_filter_offset:m.field_3.field_14,bloom_filter_length:m.field_3.field_15,size_statistics:m.field_3.field_16&&{unencoded_byte_array_data_bytes:m.field_3.field_16.field_1,repetition_level_histogram:m.field_3.field_16.field_2,definition_level_histogram:m.field_3.field_16.field_3}},offset_index_offset:m.field_4,offset_index_length:m.field_5,column_index_offset:m.field_6,column_index_length:m.field_7,crypto_metadata:m.field_8,encrypted_column_metadata:m.field_9}}),total_byte_size:h.field_2,num_rows:h.field_3,sorting_columns:(I=h.field_4)==null?void 0:I.map(m=>({column_idx:m.field_1,descending:m.field_2,nulls_first:m.field_3})),file_offset:h.field_5,total_compressed_size:h.field_6,ordinal:h.field_7}}),g=(A=o.field_5)==null?void 0:A.map(h=>({key:l(h.field_1),value:l(h.field_2)})),E=l(o.field_6);return{version:c,schema:_,num_rows:w,row_groups:d,key_value_metadata:g,created_by:E,metadata_length:i}}function be({schema:e}){return J(e,[])[0]}function ve(e){return e!=null&&e.field_1?{type:"STRING"}:e!=null&&e.field_2?{type:"MAP"}:e!=null&&e.field_3?{type:"LIST"}:e!=null&&e.field_4?{type:"ENUM"}:e!=null&&e.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e!=null&&e.field_6?{type:"DATE"}:e!=null&&e.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:V(e.field_7.field_2)}:e!=null&&e.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:V(e.field_8.field_2)}:e!=null&&e.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e!=null&&e.field_11?{type:"NULL"}:e!=null&&e.field_12?{type:"JSON"}:e!=null&&e.field_13?{type:"BSON"}:e!=null&&e.field_14?{type:"UUID"}:e!=null&&e.field_15?{type:"FLOAT16"}:e}function V(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function Le(e,t,n){return e&&{max:T(e.field_1,t,n),min:T(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:T(e.field_5,t,n),min_value:T(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function T(e,t,n){const{type:f,converted_type:i,logical_type:r}=t;if(e===void 0)return e;if(f==="BOOLEAN")return e[0]===1;if(f==="BYTE_ARRAY")return new TextDecoder().decode(e);const s=new DataView(e.buffer,e.byteOffset,e.byteLength);return f==="FLOAT"&&s.byteLength===4?s.getFloat32(0,!0):f==="DOUBLE"&&s.byteLength===8?s.getFloat64(0,!0):f==="INT32"&&i==="DATE"?n.dateFromDays(s.getInt32(0,!0)):f==="INT64"&&i==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):f==="INT64"&&i==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):f==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"&&(r==null?void 0:r.unit)==="NANOS"?n.timestampFromNanoseconds(s.getBigInt64(0,!0)):f==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"&&(r==null?void 0:r.unit)==="MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):f==="INT64"&&(r==null?void 0:r.type)==="TIMESTAMP"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):f==="INT32"&&s.byteLength===4?s.getInt32(0,!0):f==="INT64"&&s.byteLength===8?s.getBigInt64(0,!0):i==="DECIMAL"?K(e)*10**-(t.scale||0):(r==null?void 0:r.type)==="FLOAT16"?X(e):e}function x(e,t){for(let f=0;f<t.length;f+=1e4)e.push(...t.slice(f,f+1e4))}function fe(e){if(!e)return[];if(e.length===1)return e[0];const t=[];for(const n of e)x(t,n);return t}const Ne=1<<25;function Re({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:f}){var o,u;if(!e)throw new Error("parquetPlan requires metadata");const i=[],r=[];let s=0;for(const l of e.row_groups){const c=Number(l.num_rows),_=s+c;if(_>=t&&s<n){const a=[];for(const{file_path:E,meta_data:A}of l.columns){if(E)throw new Error("parquet file_path not supported");if(!A)throw new Error("parquet column metadata is undefined");(!f||f.includes(A.path_in_schema[0]))&&a.push(re(A))}const w=Math.max(t-s,0),d=Math.min(n-s,c);i.push({ranges:a,rowGroup:l,groupStart:s,groupRows:c,selectStart:w,selectEnd:d});const g=((o=a[a.length-1])==null?void 0:o.endByte)-((u=a[0])==null?void 0:u.startByte);if(!f&&g<Ne)r.push({startByte:a[0].startByte,endByte:a[a.length-1].endByte});else if(a.length)x(r,a);else if(f!=null&&f.length)throw new Error(`parquet columns not found: ${f.join(", ")}`)}s=_}return isFinite(n)||(n=s),{metadata:e,rowStart:t,rowEnd:n,columns:f,fetches:r,groups:i}}function re({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){const f=e||t;return{startByte:Number(f),endByte:Number(f+n)}}function Te(e,{fetches:t}){const n=t.map(({startByte:f,endByte:i})=>e.slice(f,i));return{byteLength:e.byteLength,slice(f,i=e.byteLength){const r=t.findIndex(({startByte:s,endByte:o})=>s<=f&&i<=o);if(r<0)throw new Error(`no prefetch for range [${f}, ${i}]`);if(t[r].startByte!==f||t[r].endByte!==i){const s=f-t[r].startByte,o=i-t[r].startByte;return n[r]instanceof Promise?n[r].then(u=>u.slice(s,o)):n[r].slice(s,o)}else return n[r]}}}function z(e,t,n,f,i){const r=(t==null?void 0:t.length)||n.length;if(!r)return f;const s=M(i),o=i.map(({element:d})=>d.repetition_type);let u=0;const l=[e];let c=e,_=0,a=0,w=0;if(n[0])for(;_<o.length-2&&w<n[0];)_++,o[_]!=="REQUIRED"&&(c=c.at(-1),l.push(c),a++),o[_]==="REPEATED"&&w++;for(let d=0;d<r;d++){const g=t!=null&&t.length?t[d]:s,E=n[d];for(;_&&(E<w||o[_]!=="REPEATED");)o[_]!=="REQUIRED"&&(l.pop(),a--),o[_]==="REPEATED"&&w--,_--;for(c=l.at(-1);(_<o.length-2||o[_+1]==="REPEATED")&&(a<g||o[_+1]==="REQUIRED");){if(_++,o[_]!=="REQUIRED"){const A=[];c.push(A),c=A,l.push(A),a++}o[_]==="REPEATED"&&w++}g===s?c.push(f[u++]):_===o.length-2?c.push(null):c.push([])}if(!e.length)for(let d=0;d<s;d++){const g=[];c.push(g),c=g}return e}function N(e,t,n=0){const f=t.path.join("."),i=t.element.repetition_type==="OPTIONAL",r=i?n+1:n;if(we(t)){let s=t.children[0],o=r;s.children.length===1&&(s=s.children[0],o++),N(e,s,o);const u=s.path.join("."),l=e.get(u);if(!l)throw new Error("parquet list column missing values");i&&D(l,n),e.set(f,l),e.delete(u);return}if(Ae(t)){const s=t.children[0].element.name;N(e,t.children[0].children[0],r+1),N(e,t.children[0].children[1],r+1);const o=e.get(`${f}.${s}.key`),u=e.get(`${f}.${s}.value`);if(!o)throw new Error("parquet map column missing keys");if(!u)throw new Error("parquet map column missing values");if(o.length!==u.length)throw new Error("parquet map column key/value length mismatch");const l=se(o,u,r);i&&D(l,n),e.delete(`${f}.${s}.key`),e.delete(`${f}.${s}.value`),e.set(f,l);return}if(t.children.length){const s=t.element.repetition_type==="REQUIRED"?n:n+1,o={};for(const l of t.children){N(e,l,s);const c=e.get(l.path.join("."));if(!c)throw new Error("parquet struct missing child data");o[l.element.name]=c}for(const l of t.children)e.delete(l.path.join("."));const u=oe(o,s);i&&D(u,n),e.set(f,u)}}function D(e,t){for(let n=0;n<e.length;n++)t?D(e[n],t-1):e[n]=e[n][0]}function se(e,t,n){const f=[];for(let i=0;i<e.length;i++)if(n)f.push(se(e[i],t[i],n-1));else if(e[i]){const r={};for(let s=0;s<e[i].length;s++){const o=t[i][s];r[e[i][s]]=o===void 0?null:o}f.push(r)}else f.push(void 0);return f}function oe(e,t){var r;const n=Object.keys(e),f=(r=e[n[0]])==null?void 0:r.length,i=[];for(let s=0;s<f;s++){const o={};for(const u of n){if(e[u].length!==f)throw new Error("parquet struct parsing error");o[u]=e[u][s]}t?i.push(oe(o,t-1)):i.push(o)}return i}function R(e,t,n){const f=n instanceof Int32Array,i=v(e),r=v(e);v(e);let s=B(e),o=0;n[o++]=f?Number(s):s;const u=i/r;for(;o<t;){const l=B(e),c=new Uint8Array(r);for(let _=0;_<r;_++)c[_]=e.view.getUint8(e.offset++);for(let _=0;_<r&&o<t;_++){const a=BigInt(c[_]);if(a){let w=0n,d=u;const g=(1n<<a)-1n;for(;d&&o<t;){let E=BigInt(e.view.getUint8(e.offset))>>w&g;for(w+=a;w>=8;)w-=8n,e.offset++,w&&(E|=BigInt(e.view.getUint8(e.offset))<<a-w&g);const A=l+E;s+=A,n[o++]=f?Number(s):s,d--}d&&(e.offset+=Math.ceil((d*Number(a)+Number(w))/8))}else for(let w=0;w<u&&o<t;w++)s+=l,n[o++]=f?Number(s):s}}}function le(e,t,n){const f=new Int32Array(t);R(e,t,f);for(let i=0;i<t;i++)n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,f[i]),e.offset+=f[i]}function Oe(e,t,n){const f=new Int32Array(t);R(e,t,f);const i=new Int32Array(t);R(e,t,i);for(let r=0;r<t;r++){const s=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[r]);f[r]?(n[r]=new Uint8Array(f[r]+i[r]),n[r].set(n[r-1].subarray(0,f[r])),n[r].set(s,f[r])):n[r]=s,e.offset+=i[r]}}function P(e){return 32-Math.clz32(e)}function y(e,t,n,f){n||(e.offset+=4);let i=0;for(;i<f.length;){const r=v(e);if(r&1)i=Pe(e,r,t,f,i);else{const s=r>>>1;De(e,s,t,f,i),i+=s}}}function De(e,t,n,f,i){const r=n+7>>3;let s=0;for(let o=0;o<r;o++)s|=e.view.getUint8(e.offset++)<<(o<<3);for(let o=0;o<t;o++)f[i+o]=s}function Pe(e,t,n,f,i){let r=t>>1<<3;const s=(1<<n)-1;let o=0;if(e.offset<e.view.byteLength)o=e.view.getUint8(e.offset++);else if(s)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let u=8,l=0;for(;r;)l>8?(l-=8,u-=8,o>>>=8):u-l<n?(o|=e.view.getUint8(e.offset)<<u,e.offset++,u+=8):(i<f.length&&(f[i++]=o>>l&s),r--,l+=n);return i}function ue(e,t,n,f){const i=Se(n,f),r=new Uint8Array(t*i);for(let s=0;s<i;s++)for(let o=0;o<t;o++)r[o*i+s]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(r.buffer);if(n==="DOUBLE")return new Float64Array(r.buffer);if(n==="INT32")return new Int32Array(r.buffer);if(n==="INT64")return new BigInt64Array(r.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const s=new Array(t);for(let o=0;o<t;o++)s[o]=r.subarray(o*i,(o+1)*i);return s}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function Se(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function F(e,t,n,f){if(n===0)return[];if(t==="BOOLEAN")return Be(e,n);if(t==="INT32")return Ue(e,n);if(t==="INT64")return Me(e,n);if(t==="INT96")return xe(e,n);if(t==="FLOAT")return Fe(e,n);if(t==="DOUBLE")return qe(e,n);if(t==="BYTE_ARRAY")return Ye(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!f)throw new Error("parquet missing fixed length");return Ce(e,n,f)}else throw new Error(`parquet unhandled type: ${t}`)}function Be(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.offset+(f/8|0),r=f%8,s=e.view.getUint8(i);n[f]=(s&1<<r)!==0}return e.offset+=Math.ceil(t/8),n}function Ue(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(S(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Me(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(S(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function xe(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.view.getBigInt64(e.offset+f*12,!0),r=e.view.getInt32(e.offset+f*12+8,!0);n[f]=BigInt(r)<<64n|i}return e.offset+=t*12,n}function Fe(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(S(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function qe(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(S(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Ye(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.view.getUint32(e.offset,!0);e.offset+=4,n[f]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i),e.offset+=i}return n}function Ce(e,t,n){const f=new Array(t);for(let i=0;i<t;i++)f[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return f}function S(e,t,n){const f=new ArrayBuffer(n);return new Uint8Array(f).set(new Uint8Array(e,t,n)),f}const $e=[0,255,65535,16777215,4294967295];function j(e,t,n,f,i){for(let r=0;r<i;r++)n[f+r]=e[t+r]}function ke(e,t){const n=e.byteLength,f=t.byteLength;let i=0,r=0;for(;i<n;){const s=e[i];if(i++,s<128)break}if(f&&i>=n)throw new Error("invalid snappy length header");for(;i<n;){const s=e[i];let o=0;if(i++,i>=n)throw new Error("missing eof marker");if((s&3)===0){let u=(s>>>2)+1;if(u>60){if(i+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const l=u-60;u=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),u=(u&$e[l])+1,i+=l}if(i+u>n)throw new Error("snappy error literal exceeds input length");j(e,i,t,r,u),i+=u,r+=u}else{let u=0;switch(s&3){case 1:o=(s>>>2&7)+4,u=e[i]+(s>>>5<<8),i++;break;case 2:if(n<=i+1)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[i]+(e[i+1]<<8),i+=2;break;case 3:if(n<=i+3)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),i+=4;break}if(u===0||isNaN(u))throw new Error(`invalid offset ${u} pos ${i} inputLength ${n}`);if(u>r)throw new Error("cannot copy from before start of buffer");j(t,r-u,t,r,o),r+=o}}if(r!==f)throw new Error("premature end of input")}function Ve(e,t,{type:n,element:f,schemaPath:i}){const r=new DataView(e.buffer,e.byteOffset,e.byteLength),s={view:r,offset:0};let o;const u=ze(s,t,i),{definitionLevels:l,numNulls:c}=je(s,t,i),_=t.num_values-c;if(t.encoding==="PLAIN")o=F(s,n,_,f.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const a=n==="BOOLEAN"?1:r.getUint8(s.offset++);a?(o=new Array(_),n==="BOOLEAN"?(y(s,a,0,o),o=o.map(w=>!!w)):y(s,a,r.byteLength-s.offset,o)):o=new Uint8Array(_)}else if(t.encoding==="BYTE_STREAM_SPLIT")o=ue(s,_,n,f.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")o=n==="INT32"?new Int32Array(_):new BigInt64Array(_),R(s,_,o);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")o=new Array(_),le(s,_,o);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:l,repetitionLevels:u,dataPage:o}}function ze(e,t,n){if(n.length>1){const f=ee(n);if(f){const i=new Array(t.num_values);return y(e,P(f),0,i),i}}return[]}function je(e,t,n){const f=M(n);if(!f)return{definitionLevels:[],numNulls:0};const i=new Array(t.num_values);y(e,P(f),0,i);let r=t.num_values;for(const s of i)s===f&&r--;return r===0&&(i.length=0),{definitionLevels:i,numNulls:r}}function U(e,t,n,f){let i;const r=f==null?void 0:f[n];if(n==="UNCOMPRESSED")i=e;else if(r)i=r(e,t);else if(n==="SNAPPY")i=new Uint8Array(t),ke(e,i);else throw new Error(`parquet unsupported compression codec: ${n}`);if((i==null?void 0:i.length)!==t)throw new Error(`parquet decompressed page length ${i==null?void 0:i.length} does not match header ${t}`);return i}function Ge(e,t,n){const i={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:r,element:s,schemaPath:o,codec:u,compressors:l}=n,c=t.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");const _=We(i,c,o);i.offset=c.repetition_levels_byte_length;const a=Ze(i,c,o),w=t.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length;let d=e.subarray(i.offset);c.is_compressed!==!1&&(d=U(d,w,u,l));const g=new DataView(d.buffer,d.byteOffset,d.byteLength),E={view:g,offset:0};let A;const h=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")A=F(E,r,h,s.type_length);else if(c.encoding==="RLE")A=new Array(h),y(E,1,0,A),A=A.map(I=>!!I);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){const I=g.getUint8(E.offset++);A=new Array(h),y(E,I,w-1,A)}else if(c.encoding==="DELTA_BINARY_PACKED")A=r==="INT32"?new Int32Array(h):new BigInt64Array(h),R(E,h,A);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")A=new Array(h),le(E,h,A);else if(c.encoding==="DELTA_BYTE_ARRAY")A=new Array(h),Oe(E,h,A);else if(c.encoding==="BYTE_STREAM_SPLIT")A=ue(i,h,r,s.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:a,repetitionLevels:_,dataPage:A}}function We(e,t,n){const f=ee(n);if(!f)return[];const i=new Array(t.num_values);return y(e,P(f),t.repetition_levels_byte_length,i),i}function Ze(e,t,n){const f=M(n);if(f){const i=new Array(t.num_values);return y(e,P(f),t.definition_levels_byte_length,i),i}}function Qe(e,{groupStart:t,selectStart:n,selectEnd:f},i,r){const{columnName:s}=i,o=[];let u,l,c=0;const _=r&&(()=>{l&&r({columnName:s,columnData:l,rowStart:t+c-l.length,rowEnd:t+c})});for(;c<f&&!(e.offset>=e.view.byteLength-1);){const a=Ke(e);if(a.type==="DICTIONARY_PAGE")u=G(e,a,i,u,void 0,0),u=Q(u,i);else{const w=(l==null?void 0:l.length)||0,d=G(e,a,i,u,l,n-c);l===d?c+=d.length-w:(_==null||_(),o.push(d),c+=d.length,l=d)}}return _==null||_(),c>f&&l&&(o[o.length-1]=l.slice(0,f-(c-l.length))),o}function G(e,t,n,f,i,r){const{type:s,element:o,schemaPath:u,codec:l,compressors:c}=n,_=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){const a=t.data_page_header;if(!a)throw new Error("parquet data page header is undefined");if(r>a.num_values&&me(u))return new Array(a.num_values);const w=U(_,Number(t.uncompressed_page_size),l,c),{definitionLevels:d,repetitionLevels:g,dataPage:E}=Ve(w,a,n);let A=$(E,f,a.encoding,n);if(g.length||d!=null&&d.length){const h=Array.isArray(i)?i:[];return z(h,d,g,A,u)}else{for(let h=2;h<u.length;h++)u[h].element.repetition_type!=="REQUIRED"&&(A=Array.from(A,I=>[I]));return A}}else if(t.type==="DATA_PAGE_V2"){const a=t.data_page_header_v2;if(!a)throw new Error("parquet data page header v2 is undefined");if(r>a.num_rows)return new Array(a.num_values);const{definitionLevels:w,repetitionLevels:d,dataPage:g}=Ge(_,t,n),E=$(g,f,a.encoding,n),A=Array.isArray(i)?i:[];return z(A,w,d,E,u)}else if(t.type==="DICTIONARY_PAGE"){const a=t.dictionary_page_header;if(!a)throw new Error("parquet dictionary page header is undefined");const w=U(_,Number(t.uncompressed_page_size),l,c),d={view:new DataView(w.buffer,w.byteOffset,w.byteLength),offset:0};return F(d,s,a.num_values,o.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function Ke(e){const t=te(e),n=W[t.field_1],f=t.field_2,i=t.field_3,r=t.field_4,s=t.field_5&&{num_values:t.field_5.field_1,encoding:b[t.field_5.field_2],definition_level_encoding:b[t.field_5.field_3],repetition_level_encoding:b[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},o=t.field_6,u=t.field_7&&{num_values:t.field_7.field_1,encoding:b[t.field_7.field_2],is_sorted:t.field_7.field_3},l=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:b[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:f,compressed_page_size:i,crc:r,data_page_header:s,index_page_header:o,dictionary_page_header:u,data_page_header_v2:l}}function Xe(e,{metadata:t,columns:n},f){const{file:i,compressors:r,utf8:s}=e,o=[],u={...Z,...e.parsers};for(const{file_path:l,meta_data:c}of f.rowGroup.columns){if(l)throw new Error("parquet file_path not supported");if(!c)throw new Error("parquet column metadata is undefined");const _=c.path_in_schema[0];if(n&&!n.includes(_))continue;const{startByte:a,endByte:w}=re(c),d=w-a;if(d>1<<30){console.warn(`parquet skipping huge column "${c.path_in_schema}" ${d} bytes`);continue}const g=Promise.resolve(i.slice(a,w));o.push({pathInSchema:c.path_in_schema,data:g.then(E=>{const A=J(t.schema,c.path_in_schema),h={view:new DataView(E),offset:0},m={columnName:c.path_in_schema.join("."),type:c.type,element:A[A.length-1].element,schemaPath:A,codec:c.codec,parsers:u,compressors:r,utf8:s};return Qe(h,f,m,e.onPage)})})}return{groupStart:f.groupStart,groupRows:f.groupRows,asyncColumns:o}}async function He({asyncColumns:e},t,n,f,i){const r=new Array(n),s=await Promise.all(e.map(({data:c})=>c.then(fe))),o=e.map(c=>c.pathInSchema[0]).filter(c=>!f||f.includes(c)),u=f??o,l=u.map(c=>e.findIndex(_=>_.pathInSchema[0]===c));for(let c=t;c<n;c++)if(i==="object"){const _={};for(let a=0;a<e.length;a++)_[e[a].pathInSchema[0]]=s[a][c];r[c]=_}else{const _=new Array(e.length);for(let a=0;a<u.length;a++)l[a]>=0&&(_[a]=s[l[a]][c]);r[c]=_}return r}function Je(e,t){const{asyncColumns:n}=e,f=[];for(const i of t.children)if(i.children.length){const r=n.filter(u=>u.pathInSchema[0]===i.element.name);if(!r.length)continue;const s=new Map,o=Promise.all(r.map(u=>u.data.then(l=>{s.set(u.pathInSchema.join("."),fe(l))}))).then(()=>{N(s,i);const u=s.get(i.path.join("."));if(!u)throw new Error("parquet column data not assembled");return[u]});f.push({pathInSchema:i.path,data:o})}else{const r=n.find(s=>s.pathInSchema[0]===i.element.name);r&&f.push(r)}return{...e,asyncColumns:f}}async function et(e){e.metadata??(e.metadata=await ye(e.file));const t=await tt(e),{rowStart:n=0,rowEnd:f,columns:i,onChunk:r,onComplete:s,rowFormat:o}=e;if(!s&&!r){for(const{asyncColumns:c}of t)for(const{data:_}of c)await _;return}const u=be(e.metadata),l=t.map(c=>Je(c,u));if(r)for(const c of l)for(const _ of c.asyncColumns)_.data.then(a=>{let w=c.groupStart;for(const d of a)r({columnName:_.pathInSchema[0],columnData:d,rowStart:w,rowEnd:w+d.length}),w+=d.length});if(s){const c=[];for(const _ of l){const a=Math.max(n-_.groupStart,0),w=Math.min((f??1/0)-_.groupStart,_.groupRows),d=await He(_,a,w,i,o);x(c,d.slice(a,w))}s(c)}else for(const{asyncColumns:c}of l)for(const{data:_}of c)await _}function tt(e){if(!e.metadata)throw new Error("parquet requires metadata");const t=Re(e);return e.file=Te(e.file,t),t.groups.map(n=>Xe(e,t,n))}function nt(e){return new Promise((t,n)=>{et({rowFormat:"object",...e,onComplete:t}).catch(n)})}export{fe as flatten,k as parquetMetadata,ye as parquetMetadataAsync,et as parquetRead,nt as parquetReadObjects,be as parquetSchema,ke as snappyUncompress};
